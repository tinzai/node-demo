webpackJsonp([42],{358:function(e,t,s){var i=s(0)(s(668),s(935),null,null);e.exports=i.exports},668:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s(6),n=s(75);t.default={name:"PageOnlineService",data:function(){return{isReady:!1,waitingService:!0,serverUrl:"",messages:[],message:"",scrollTimer:null,dependencies:{jquery:"/staticm/onlineServiceScript/jquery-1.10.2.min.js",signalr:"/staticm/onlineServiceScript/jquery.signalR-2.2.1.min.js",signalrhub:"/staticm/onlineServiceScript/signalrhub.js"},clipboard:!1,supportClipboard:!1}},computed:{isMobile:function(){return this.$store.state.isMobile},qqOfService:function(){return this.$store.getters.qqOfService},addContactLink:function(){return this.$store.state.isMobile?"mqqwpa://im/chat?chat_type=wpa&uin="+this.$store.getters.qqOfService+"&version=1&src_type=web":"tencent://message/?uin="+this.$store.getters.qqOfService+"&Site=web&Menu=yes"}},watch:{messages:function(){this.scrollToBottom()},isReady:function(e){var t=this;!1!==e&&this.fetchOnlineServiceInfo().then(function(){t.writeCookieForOnlineService()}).then(function(){t.initOnlineService()})}},methods:{scrollToBottom:function(){clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(function(){window.scrollTo(0,window.document.body.scrollHeight)},100)},uninstallDependencyScripts:function(){var e=null,t=void 0;for(t in this.dependencies)this.dependencies.hasOwnProperty(t)&&(e=document.getElementById(t))&&e.parentNode.removeChild(e)},installDependencyScripts:function(){var e=this,t=null,s=void 0,i=Math.random(),n={};this.isReady=!1;for(s in this.dependencies)this.dependencies.hasOwnProperty(s)&&(t=document.createElement("script"),t.id=s,t.src=this.dependencies[s]+"?v="+i,n[s]=t);n.jquery.onload=function(){document.body.appendChild(n.signalr)},n.signalr.onload=function(){document.body.appendChild(n.signalrhub)},n.signalrhub.onload=function(){e.isReady=!0},document.body.appendChild(n.jquery)},fetchOnlineServiceInfo:function(){var e=this;return i.apiGetOnlineServiceURL().then(function(t){e.serverUrl="http://"+t.data}).catch(function(t){console.log(t),e.$message({message:"获取服务器地址出错啦！",type:"error",force:!0})})},writeCookieForOnlineService:function(){var e=encodeURIComponent(document.cookie),t=window.navigator.userAgent.toLowerCase(),s=this.serverUrl+"/online_service_setcookie.aspx?cookie="+e;if(!this.$route.query.f&&-1===t.indexOf("akapp")&&(t.indexOf("safari")>-1&&-1===t.indexOf("chrome")||t.indexOf("miuibrowser")>-1))location.href=s+"&callback="+encodeURIComponent(location.href+"?f=1");else{var i=document.getElementById("osc");i&&i.parentNode.removeChild(i),i=document.createElement("iframe"),i.id="osc",i.src=s,i.style.display="none",document.body.appendChild(i)}},openConnection:function(){$.connection.hub.start({xdomain:!0}).done(function(){$.connection.serviceHub.server.userConnect()}).fail(function(e){console.log(e)})},closeConnection:function(){$.connection.hub.stop()},initOnlineService:function(){$.connection.hub.url=this.serverUrl+"/signalr",$.extend($.connection.serviceHub.client,{onServiceConnected:this.whenServiceOnline,onServiceDisconnected:this.whenServiceOffline,onSelfDisconnected:this.whenLetUserOffline,sendMsgError:this.whenSendMessageFail,onSelfOffline:this.whenUserOffline,receiveMsg:this.whenRecieveMessage}),this.openConnection()},whenServiceOnline:function(e,t,s){var i=this,n=this;setTimeout(function(){n.waitingService=!1},1e3),s&&s.forEach(function(e){i.messages.push({type:e.IS_IMAGE?"image":"text",content:e.CONTENT,datetime:i.getTime(e.ADD_DATE),author:"user"!==e.IP&&e.SEND_USER_NAME})}),this.messages.push({type:"text",content:"您好，我是["+t+"]，很高兴为您服务，请问您需要什么帮助？",datetime:this.getTime(),author:t})},whenServiceOffline:function(e){this.messages.push({type:"text",content:e+"当前已下线，稍后联系！",datetime:this.getTime(),author:"系统"})},whenLetUserOffline:function(){this.messages.push({type:"text",content:"当前会话已结束，若仍需咨询请重新进入本页！",datetime:this.getTime(),author:"系统"}),this.closeConnection()},whenSendMessageFail:function(){this.$message({message:"抱歉，消息发送失败，请重新发送！",type:"warning"})},whenUserOffline:function(){this.messages.push({type:"text",content:"您已下线，请重新登录！",datetime:this.getTime(),author:"系统"}),this.closeConnection()},whenRecieveMessage:function(e,t,s,i,n){this.messages.push({type:"pic"===i?"image":"text",content:s,datetime:n,author:t})},getTime:function(e){var t=s.i(n.b)("","Y:M:D"),i=void 0;return void 0===e?i=s.i(n.b)("","h:i:s"):(e=e.replace("T"," "),i=s.i(n.b)("","Y:M:D"),i=i===t?s.i(n.b)("","h:i:s"):e),i},sendImage:function(e){var t=this;try{var s=e.target,n=e.file,o=e.name;i.apiUploadImageForOnlineService({filename:o,image:n}).then(function(e){return e.json()}).then(function(e){"1406"===e.S?($.connection.serviceHub.server.userSendMsg(e.D,"","pic"),t.messages.push({type:"image",content:n,datetime:t.getTime(),author:!1}),s.value=""):t.$message({message:e.S+": "+e.D,type:"warning"})}).catch(function(e){console.log(e),t.$message({message:"上传图片失败啦！",type:"error",force:!1})})}catch(e){console.log(e),this.messages.push({type:"text",content:"发送图片失败啦！",datetime:this.getTime(),author:!1})}},validators:function(){return""===this.message?(this.$message({message:"对不起，不能发送空消息哦！"}),!1):!(this.message.length>100)||(this.$message({message:"对不起，一条消息不能超过100字哦！"}),!1)},sendMessage:function(){if(!1!==this.validators())try{$.connection.serviceHub.server.userSendMsg(this.message,"","text"),this.messages.push({type:"text",content:this.message,datetime:this.getTime(),author:!1}),this.message=""}catch(e){console.log(e),this.messages.push({type:"text",content:"发送消息失败啦！",datetime:this.getTime(),author:!1})}},checkIfSupportClipboard:function(){var e=!1,t=null,s=document.documentElement;"undefined"!=typeof Clipboard&&(t=new Clipboard(s)).constructor.isSupported()?e="clipboard":"undefined"!=typeof ZeroClipboard&&(t=new ZeroClipboard(s)).constructor.isFlashUnusable()?e="zeroclipboard":(null!==t&&t.destroy(),"undefined"!=typeof ZeroClipboard&&ZeroClipboard.destroy()),this.supportClipboard=e},createClipboard:function(){var e=this,t=!1,s='成功复制<strong class="important">[客服QQ:'+this.qqOfService+"]</strong>到剪贴板！";"clipboard"===this.supportClipboard?(t=new Clipboard(".js-add-qq-contact"),t.on("success",function(t){e.$message({type:"success",message:s})}),t.on("error",function(e){console.log(e)})):"zeroclipboard"===this.supportClipboard&&(t=new ZeroClipboard(document.querySelectorAll(".js-add-qq-contact")),t.on("ready",function(){this.on("copy",function(){e.$message({type:"success",message:s})})}),t.on("error",function(e){console.log('error[name="'+e.name+'"]: '+e.message),ZeroClipboard.destroy()})),this.clipboard=t},manualCopy:function(){this.isMobile&&!1===this.supportClipboard&&this.$message({message:'您的浏览器版本较低，请手动复制<strong class="important">[客服QQ:'+this.qqOfService+"]</strong>，或者更换浏览器后再试！",force:!0})}},created:function(){this.$store.commit("setPage",{pageTitle:"在线客服",className:"page-online-service"}),this.isMobile&&this.checkIfSupportClipboard(),this.installDependencyScripts()},mounted:function(){this.isMobile},beforeDestroy:function(){!1!==this.clipboard&&(this.clipboard.destroy(),this.clipboard=!1),this.closeConnection(),this.uninstallDependencyScripts()}}},935:function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("main",{staticClass:"kd-body chat-room online-service-chat-room"},[s("transition",{attrs:{"leave-active-class":"animated fade-out"}},[e.waitingService?s("div",{staticClass:"waiting kd-row-middle"},[s("div",{staticClass:"inner"},[s("div",{staticClass:"ball-scale-multiple"},[s("div",{staticClass:"item"}),e._v(" "),s("div",{staticClass:"item"}),e._v(" "),s("div",{staticClass:"item"})]),e._v(" "),s("div",{staticClass:"text"},[e._v("正在连线客服...敬请稍候！"),s("div",{staticClass:"remind"},[e._v("为确保您不与本站失去联系，造成不必要的损失，请及时添加我们的客服QQ"),s("br"),s("a",{staticClass:"kd-button add-qq-contact js-add-qq-contact",attrs:{href:e.addContactLink,"data-clipboard-text":e.qqOfService}},[s("i",{staticClass:"icon icon-qq"}),e._v(e._s(e.qqOfService))])])])])]):e._e()]),e._v(" "),s("dl",{staticClass:"kd-container chat-messages"},[e._m(0),e._v(" "),s("dd",{staticClass:"chat-message remind-message"},[s("div",{staticClass:"inner"},[e._v("为确保您不与本站失去联系，造成不必要的损失，请及时添加我们的客服QQ "),s("a",{staticClass:"kd-button add-qq-contact js-add-qq-contact",attrs:{href:e.addContactLink,"data-clipboard-text":e.qqOfService}},[s("i",{staticClass:"icon icon-qq"}),e._v(e._s(e.qqOfService))])])]),e._v(" "),e._l(e.messages,function(t,i){return[s("dt",{key:"author-"+i,staticClass:"chat-author",class:{self:!t.author}},[t.author?[s("i",{staticClass:"icon"}),e._v(" "),s("span",{staticClass:"name"},[e._v(e._s(t.author))]),e._v(" "),s("time",{staticClass:"time"},[e._v(e._s(t.datetime))])]:[s("time",{staticClass:"time"},[e._v(e._s(t.datetime))]),e._v(" "),s("i",{staticClass:"icon"})]],2),e._v(" "),s("dd",{key:"message-"+i,staticClass:"chat-message",class:{self:!t.author}},["image"===t.type?s("div",{staticClass:"inner"},[s("img",{attrs:{src:t.content,alt:"image"}})]):s("div",{staticClass:"inner"},[e._v(e._s(t.content))])])]})],2),e._v(" "),s("div",{staticClass:"chat-textinput"},[s("div",{directives:[{name:"textinput",rawName:"v-textinput"}],staticClass:"kd-textinput"},[s("textarea",{directives:[{name:"model",rawName:"v-model.trim",value:e.message,expression:"message",modifiers:{trim:!0}},{name:"focus-fixed",rawName:"v-focus-fixed"}],attrs:{placeholder:"请输入消息内容，最多100个字"},domProps:{value:e.message},on:{input:function(t){t.target.composing||(e.message=t.target.value.trim())},blur:function(t){return e.$forceUpdate()}}})]),e._v(" "),s("kd-upload",{on:{"upload-file":function(t){return e.sendImage(t)}}}),e._v(" "),s("kd-button",{staticClass:"send",on:{click:e.sendMessage}},[s("span",[e._v("发 送")])])],1)],1)},staticRenderFns:[function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("dt",{staticClass:"chat-author"},[s("i",{staticClass:"icon"}),e._v(" "),s("span",{staticClass:"name"},[e._v("温馨提醒：")])])}]}}});